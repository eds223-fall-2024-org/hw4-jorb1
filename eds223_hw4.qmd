---
title: "Prioritizing Potential Aquaculture Zones in Coastal California"
subtitle: "EDS 223 Homework #4"
author: "Bailey Jørgensen"
execute:
  warning: false
  message: false
format:
  html:
    code-fold: true
    toc: true
editor_options: 
  chunk_output_type: console
---

## Background

Marine aquaculture has the potential to play an important role in the global food supply as a more sustainable protein option than land-based meat production. Gentry et al. mapped the potential for marine aquaculture globally based on multiple constraints, including ship traffic, dissolved oxygen, and bottom depth. They found that global seafood demand could be met using less than 0.015% of the global ocean area.

For this analysis, I will determine which Exclusive Economic Zones (EEZ) on the West Coast of the United States are best suited to developing marine aquaculture for several species of oysters and (CHOOSE AN ANIMAL JORB). Suitable locations will be determined based on a range of suitable sea surface temperatures (SST) and depth values for the species. 

Data on species depth and temperature requirements came from SeaLifeBase. 

Data on sea surface temperatures came from NOAA's 5km Daily Global Satellite Sea Surface Temperature Anomaly v3.1.

Bathymetry data came from the General Bathymetric Chart of the Oceans (GEBCO). 

Data on Exclusive Economic Zones came from Marineregions.org. 
```{r, output = FALSE}
#| eval: true
#| echo: false

# Load libraries
library(tidyverse)
library(sf)
library(terra)
library(tmap)
library(tmaptools)
library(here)
library(testthat)
library(patchwork)
library(ggplot2)
library(tidyterra)
library(patchwork)
```

```{r, output = FALSE}
#| eval: true
#| echo: false
# Read in data

# Create a list of all images that have the extension.tif and contain the word sst
sst_list <- list.files("data",
                       pattern = glob2rx("*sst*.tif$"),
                       full.names = TRUE)

# Create a stack of the sst rasters
sst_stack <- rast(sst_list)

# Read in bathymetry raster data
bathymetry <- rast(here::here("data", "depth.tif"))

# Read in maritime boundaries vector file
maritime_boundaries <- read_sf(here::here("data", "wc_regions_clean.shp"))

```

```{r}
# Put any functions I create here?
```

```{r}
# Transform the CRS of the files to match
bathymetry <- terra::project(bathymetry, crs(sst_stack))

maritime_boundaries <- maritime_boundaries %>% 
  st_transform(crs = st_crs(bathymetry))

# Confirm that the CRS transformed as expected
test_that("The CRS of all data sets match", {
  expect_true(crs(sst_stack) == crs(bathymetry) && crs(bathymetry) == crs(maritime_boundaries))
})
```
## Data Processing

In order to perform this analysis, the data must be processed. Specifically, I must ensure that the Sea Surface Temperature data and Depth data can be combined, since the data have different resolutions, extents, and positions.


```{r}
# Find the mean SST from 2008-2012 (eg create single raster of average SST...)
sst_average <- mean(sst_stack)

# Convert average SST from Kelvin to Celsius by subtracting 273.15
sst_average_celsius <- sst_average - 273.15

```

After some initial processing of the SST raster stack, I want to take a quick look at the the bathymetry and SST data, to see what further processing might need to be done.


```{r, fig.width=10, fig.height=6}

# Plot bathymetry raster
plot_bathymetry <- ggplot() +
  geom_spatraster(data = bathymetry) +
  scale_fill_viridis_c(name = "Depth") +
  ggtitle("Bathymetry") +
  theme_minimal()

# Plot SST raster
plot_sst <- ggplot() +
  geom_spatraster(data = sst_average_celsius) +
  scale_fill_viridis_c(name = "Temperature (°C)") +
  ggtitle("Average SST (°C)") +
  theme_minimal()

# Combine the plots
plot_bathymetry + plot_sst

```
I suspect that the resolutions of these raster objects do not match, so I run a quick check to see:

```{r, echo=TRUE, results='markdown'}
cat("Resolution of SST Average (°C):", res(sst_average_celsius)[1], "x", res(sst_average_celsius)[2], "\n")
cat("Resolution of Bathymetry:", res(bathymetry)[1], "x", res(bathymetry)[2], "\n")
```
This check confirms my suspicions, and I decide to resample the bathymetry data to match the resolution of the SST data, using the nearest neighbor approach. Once the resolutions and CRS of the data matches, I can crop the bathymetry raster to match the extent of the SST raster. 

```{r, echo=TRUE, results='asis'}
# Resample the bathymetry data to match the resolution of the SST data using the nearest neighbor approach
bathymetry_resampled <- resample(bathymetry, sst_stack, method = "near")

# Verify the results
cat("Matched Resolution of SST Average (°C):", res(sst_average_celsius)[1], "x", res(sst_average_celsius)[2], "\n")
cat("Matched Resolution of Bathymetry:", res(bathymetry)[1], "x", res(bathymetry_resampled)[2], "\n")
    
# Crop the bathymetry raster at last
bathymetry_cropped <- crop(bathymetry_resampled, sst_average_celsius)

```

Now, to verify that my processing thus far has been successful, I will run a series of tests. One way to know that the rasters match, is if they are able to be successfully stacked together. This code will test for stackability, and then I will finally stack the two together. 

```{r}
#| echo: true
#| output: asis

# Check if the rasters have the same resolution
res_match <- all(res(bathymetry_cropped) == res(sst_average_celsius))

# Check if the rasters have the same extent
extent_match <- ext(bathymetry_cropped) == ext(sst_average_celsius)

# Check if the rasters have the same CRS
crs_match <- crs(bathymetry_cropped) == crs(sst_average_celsius)

# Print the results
cat("Resolution match:", res_match,"\n")
cat("Extent match:", extent_match,"\n")
cat("CRS match:", crs_match,"\n")

# Check if the rasters can be stacked
if (res_match && extent_match && crs_match) {
  print("The rasters can be stacked. Aw yeah!")
} else {
  print("The rasters cannot be stacked. Check your work!!!")
}

# Finally, lets do it! Stack that raster!
bathy_sst <- c(bathymetry_cropped, sst_average_celsius)
```

## Oysters: A "Pearl-fect" Match


After the data is properly prepared and processed, I can begin the analysis to find suitable locations for marine aquaculture. This means finding locations that are suitable in terms of both SST and depth. 

I will begin my analysis with oysters. Research has shown that oyster need the following conditions for optimal growth: 

- sea surface temperature: 11-30°C
- depth: 0-70 meters below sea level

*(
Tip: finding suitable locations
The SST and depth rasters should now identify the suitability of locations as 0 or 1. To find locations that have both suitable temperature and depth, you can use map algebra. One idea is to multiple the values of the cells, using the lapp() function.)*

```{r}
# Reclassify SST and depth data into locations that are suitable for oysters. (hint: set suitable values to 1 and unsuitable values to 0)
```

```{r}
# Find locations that satisfy both SST and depth conditions 
```







